name: Daily AI News Agent

on:
  # Run daily at 12:01 AM PST (8:01 AM UTC)
  schedule:
    - cron: '1 8 * * *'

  # Allow manual trigger from GitHub UI
  workflow_dispatch:

# Permissions needed for creating issues
permissions:
  contents: read
  issues: write

# Environment variables available to all jobs and steps
env:
  GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
  GOOGLE_CLOUD_LOCATION: ${{ secrets.GOOGLE_CLOUD_LOCATION }}
  GOOGLE_GENAI_USE_VERTEXAI: ${{ secrets.GOOGLE_GENAI_USE_VERTEXAI }}
  LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
  LINKEDIN_ORGANIZATION_ID: ${{ secrets.LINKEDIN_ORGANIZATION_ID }}

jobs:
  fetch-and-draft-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}

      - name: Fetch and Draft AI News
        id: draft_news
        run: |
          python scripts/generate_daily_draft.py

      - name: Upload draft as artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily-news-draft-${{ github.run_number }}
          path: drafts/
          retention-days: 7

      - name: Create GitHub Issue with Draft
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'drafts/latest_draft.md';

            let draftContent = 'No draft generated';
            if (fs.existsSync(path)) {
              draftContent = fs.readFileSync(path, 'utf8');
            }

            const today = new Date().toISOString().split('T')[0];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `AI Daily Brief - ${today}`,
              body: `## Today's AI News Draft\n\n${draftContent}\n\n---\n\n**Instructions:**\n1. Copy the LinkedIn post from the code block above\n2. Go to [AI Daily Brief LinkedIn Page](https://www.linkedin.com/company/111211103/admin/)\n3. Click "+ Create" -> "Start a post"\n4. Paste and publish!\n\n*This issue was auto-generated by the Daily AI News workflow.*`,
              labels: ['daily-news', 'auto-generated']
            });
